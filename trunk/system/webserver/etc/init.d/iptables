#!/bin/bash
#
# Webserver Firewall Rules
#
# DO NOT EDIT THIS FILE ON THE WEBSERVERS!
#
# Edit the copy on jam and rsync to all webservers
# /var/www/geograph_svn/system/webserver/etc/init.d/iptables
#



case "$1" in
    start)
      echo "Initialising iptables rules"

#flush rules
iptables -F 



#basic rules
iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -j REJECT
iptables -A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT


#--------------------------------
# outgoing ports
#--------------------------------

#ssh
iptables -A OUTPUT -p tcp --dport 22 -j ACCEPT

#smtp
iptables -A OUTPUT -p tcp --dport 25 -j ACCEPT

#dns
iptables -A OUTPUT -p udp --dport 53 -j ACCEPT
iptables -A OUTPUT -p tcp --dport 53 -j ACCEPT

#http
iptables -A OUTPUT -p tcp --dport 80 -j ACCEPT

#smb
iptables -A OUTPUT -d 87.124.24.35 -p udp -m udp --dport 137 -j ACCEPT
iptables -A OUTPUT -d 87.124.24.35 -p udp -m udp --dport 138 -j ACCEPT
iptables -A OUTPUT -d 87.124.24.35 -p tcp -m tcp --dport 139 -j ACCEPT

#ntp
iptables -A OUTPUT -p udp --dport 123 -j ACCEPT

#mysql
iptables -A OUTPUT -d 87.124.24.35 -p tcp --dport 3306 -j ACCEPT

#nfs to jam (well, anything to jam really)
iptables -A OUTPUT -d 87.124.24.35 -p tcp -j ACCEPT
iptables -A OUTPUT -d 87.124.24.35 -p udp -j ACCEPT

#memcache
iptables -A OUTPUT -p tcp -s 87.124.24.32/23 --dport 11211 -j ACCEPT


#--------------------------------
# public ports
#--------------------------------

#ssh

# from http://www.debian-administration.org/articles/187
# here we limit the number of new connection attempts you can make
# before we start dropping packets...

#add new connection attempts to a recent list
iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent \
  --set

#drop packets if hitcount is 4 in the past 60 seconds
iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent \
  --update --seconds 60 --hitcount 4 -j DROP

#if you get this far, we accept the connection
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

#web
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

#icmp/ping
iptables -A INPUT -p icmp -j ACCEPT

#munin
iptables -A INPUT -p tcp -s 87.124.24.32/23 --dport 4949 -j ACCEPT

#memcache
iptables -A INPUT -p tcp -s 87.124.24.32/23 --dport 11211 -j ACCEP


#--------------------------------
# restricted ports
#--------------------------------

#allow anything from localhost
iptables -A INPUT -s 127.0.0.1 -j ACCEPT


#--------------------------------
# finally, reject everything
#--------------------------------

#final rules reject everything
iptables -A INPUT -j REJECT
iptables -A OUTPUT -j REJECT


;;

stop)
	echo "Clearing all iptables rules"
	iptables -F
	;;

status)
	iptables --list
	;;
*)	
	echo "Usage: iptables start|stop|status" >&2
	exit 1
esac

exit 0
