#!/bin/sh
set -eu
cat <<EOF

source sample8E: sample6 {
        sql_query_pre           = SET CHARACTER SET 'utf8'
        sql_query_pre           = SET SESSION query_cache_type=OFF
        sql_query_pre           = SET SESSION group_concat_max_len = 100000

	sql_query_pre           = SELECT @myself := '$HOSTNAME'

        sql_query_range         = SELECT max_doc_id+1,(SELECT MAX(gridimage_id) FROM gridimage_search)+1 FROM sph_counter WHERE server_id = '$HOSTNAME' AND counter_id='sample8D'

	sql_query_pre           = CREATE TEMPORARY TABLE sphinx_tags (gridimage_id INT UNSIGNED PRIMARY KEY) SELECT gridimage_id,\
                                GROUP_CONCAT(DISTINCT IF(prefix='top',tag,NULL) ORDER BY tag_id SEPARATOR ';') AS contexts,\
                                GROUP_CONCAT(DISTINCT IF(prefix='top',tag_id,NULL) ORDER BY tag_id SEPARATOR ',') AS context_ids,\
                                GROUP_CONCAT(DISTINCT IF(prefix='subject',tag,NULL) ORDER BY tag_id SEPARATOR ';') AS subjects,\
                                GROUP_CONCAT(DISTINCT IF(prefix='subject',tag_id,NULL) ORDER BY tag_id SEPARATOR ',') AS subject_ids,\
                                GROUP_CONCAT(DISTINCT IF(prefix='type',tag,NULL) ORDER BY tag_id SEPARATOR ';') AS types,\
                                GROUP_CONCAT(DISTINCT IF(prefix='type',tag_id,NULL) ORDER BY tag_id SEPARATOR ',') AS type_ids,\
                                GROUP_CONCAT(DISTINCT IF(prefix='top' OR prefix='bucket' OR prefix='type' OR prefix='subject',NULL,IF(prefix!='',CONCAT(prefix,':',tag),tag)) ORDER BY tag_id SEPARATOR ';') AS tags,\
                                GROUP_CONCAT(DISTINCT IF(prefix='top' OR prefix='bucket' OR prefix='type' OR prefix='subject',NULL,tag_id) ORDER BY tag_id SEPARATOR ',') AS tag_ids\
                        FROM gridimage_tag gt INNER JOIN tag t USING (tag_id)\
                        WHERE gt.status = 2 and t.status = 1 AND gridimage_id BETWEEN (SELECT max_doc_id FROM sph_counter WHERE server_id = '$HOSTNAME' AND counter_id='sample8D') AND 4294967296 \
                        GROUP BY gridimage_id ORDER BY NULL

	sql_attr_multi          = uint my_square from ranged-query; \
		select gridimage_id, u.user_id from gridimage_search inner join user_gridsquare u using (grid_reference) WHERE gridimage_id>=\$start AND gridimage_id<=\$end order by gridimage_id; \
		SELECT max_doc_id+1,(SELECT MAX(gridimage_id) FROM gridimage_search)+1 FROM sph_counter WHERE server_id = '$HOSTNAME' AND counter_id='sample8D';

	sql_attr_multi          = uint content_ids from query; \
		(select gridimage_id,content_id from gridimage_content WHERE gridimage_id > (SELECT max_doc_id FROM sph_counter WHERE server_id = '$HOSTNAME' AND counter_id='sample8D') ) \
		UNION (select id as gridimage_id,1 as content_id from gallery_ids WHERE baysian > 3 AND id > (SELECT max_doc_id FROM sph_counter WHERE server_id = '$HOSTNAME' AND counter_id='sample8D')) \
		UNION (select gridimage_id,2 as content_id from gridimage_daily where showday <= date(now()) and gridimage_id > (SELECT max_doc_id FROM sph_counter WHERE server_id = '$HOSTNAME' AND counter_id='sample8D') ) \
		UNION (select gp.gridimage_id,content_id from content inner join gridimage_post gp on (foreign_id=topic_id) where source in ('gallery','themed','gsd') AND gp.gridimage_id > (SELECT max_doc_id FROM sph_counter WHERE server_id = '$HOSTNAME' AND counter_id='sample8D') ) \
		UNION (select gs.gridimage_id,content_id from content inner join gridimage_snippet gs on (foreign_id=snippet_id) where source = 'snippet' AND gs.gridimage_id between (SELECT max_doc_id FROM sph_counter WHERE server_id = '$HOSTNAME' AND counter_id='sample8D') and 4294967296 ) \
		ORDER BY gridimage_id

        sql_attr_multi          = uint context_ids from field
        sql_attr_multi          = uint subject_ids from field
        sql_attr_multi          = uint type_ids from field
        sql_attr_multi          = uint tag_ids from field
        sql_attr_multi          = uint group_ids from field
        sql_attr_multi          = uint term_ids from field
        sql_attr_multi          = uint snippet_ids from field
        sql_attr_multi          = uint wiki_ids from field

        sql_query_killlist = \
                SELECT gridimage_id FROM gridimage WHERE moderation_status = 'rejected' AND upd_timestamp > date_sub(now(),interval 1 day)
}
index sample8E: sample6 {
        source                  = sample8E
        path                    = /var/lib/manticore/data/sample8E
}

EOF

