#Minimal configuration required to get a running site 
# - see geograph.conf for a more complete example (if can modify httpd.conf file) 
# only use one, either geograph.conf or .htaccess
#place in the document root (eg public_html/.htaccess)


    #php config
    php_value include_path .:/home/www/geograph.elphin/libs/:/usr/share/pear
    php_value register_globals Off
    php_value upload_max_filesize 8M
    php_value arg_separator.output &amp;
    php_value session.use_trans_sid  1
    php_value allow_call_time_pass_reference 1
    #php_value phpa on

    php_value suhosin.post.max_array_depth 0
    php_value suhosin.post.max_array_index_length 0
    php_value suhosin.post.max_vars 0
    php_value suhosin.request.max_array_depth 0
    php_value suhosin.request.max_array_index_length 0
    php_value suhosin.request.max_vars 0


    <IfModule mod_mime.c>
    AddType application/vnd.google-earth.kml+xml kml
    AddType application/vnd.google-earth.kmz kmz
    </IfModule>

    FileETag MTime Size

    <IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/gif "access plus 30 days"
    ExpiresByType image/png "access plus 30 days"
    ExpiresByType image/jpeg "access plus 180 days"
    ExpiresByType text/css "access plus 180 days"
    ExpiresByType application/x-javascript "access plus 180 days"
    ExpiresByType image/x-icon "access plus 180 days"
    ExpiresByType application/xml "access plus 7 days"
    #FIXME ExpiresDefault "access plus 1 days"
    </IfModule>

    #<IfModule mod_deflate.c>
    #<files *.js>
    #SetOutputFilter DEFLATE
    #</files>
    #<files *.css>
    #SetOutputFilter DEFLATE
    #</files>
    #</IfModule>

Options -Indexes
Options -Multiviews

    RewriteEngine on
    RewriteBase /

    #redirect to canonical url
    #http://httpd.apache.org/docs/misc/rewriteguide.html
    RewriteCond %{HTTP_HOST}   !^www\.example\.com [NC]
    RewriteCond %{HTTP_HOST}   !^$
    RewriteRule ^(.*)         http://www.example.com/$1 [L,R]
    #the following includes a fix as some useragents auto add a / to what it thinks is a folder

    #different robot.txt files for different domains
    #RewriteCond %{HTTP_HOST} ^english-version\.example\.com$
    #RewriteRule ^robots.txt robots-en.txt [L]

    #clients we don't like
    #RewriteCond %{HTTP_USER_AGENT} MJ12bot [NC,OR]
    #RewriteCond %{HTTP_USER_AGENT} Java/1\.6\.0_20 [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} GSLFbot [NC]
    RewriteRule ^.* - [F,L]

    RewriteRule ^tile/([0-9]+)/([0-9]+)/([0-9]+)\.png /tile.php?Z=$1&x=$2&y=$3 [qsa]
    RewriteRule ^tile/(-?[0-9]+)/([0-9]+)/([0-9]+)/([0-9]+)\.png /tile.php?t=$1&Z=$2&x=$3&y=$4 [qsa]
    RewriteRule ^tile/(1)/([28])/([0-9]+)/([0-9]+)/([0-9]+)\.png /tile.php?o=$1&l=$2&Z=$3&x=$4&y=$5 [qsa]
    RewriteRule ^tile/(-?[0-9]+)/(1)/([28])/([0-9]+)/([0-9]+)/([0-9]+)\.png /tile.php?t=$1&o=$2&l=$3&Z=$4&x=$5&y=$6 [qsa]
    RewriteRule ^tile/(2)/(11)/([0-9]+)/([0-9]+)/([0-9]+)\.png /tile.php?o=$1&l=$2&Z=$3&x=$4&y=$5 [qsa]
    RewriteRule ^tile/(-?[0-9]+)/(2)/(11)/([0-9]+)/([0-9]+)/([0-9]+)\.png /tile.php?t=$1&o=$2&l=$3&Z=$4&x=$5&y=$6 [qsa]

    RewriteRule ^photo/([0-9]+)\.xml /api/photo/$1 [qsa]
    RewriteRule ^api/.* /restapi.php [qsa]
    RewriteRule ^photo/([0-9]+)\.rdf /rdfapi.php?id=$1 [qsa]
    RewriteRule ^photo/([0-9]+)\.kml /kml.php?id=$1 [qsa]
    RewriteRule ^photo/([0-9]+) /view.php?id=$1 [qsa]
    RewriteRule ^gridref/([A-Za-z]{1,3})$ /myriad.php?myriad=$1 [qsa]
    RewriteRule ^gridref/([A-Za-z]{1,3}[0-9]{2})$ /hectad.php?hectad=$1 [qsa]
    RewriteRule ^gridref/(.*)/links /location.php?gridref=$1 [qsa]
    RewriteRule ^gridref/(.*) /browse.php?gridref=$1 [qsa]

    RewriteRule ^help/([^/]*) /staticpage.php?page=$1 [qsa]

    RewriteRule ^profile/([0-9]+)/feed(|/[0-9]+)/recent\.([\w]+) /syndicator.php?page=$2&u=$1&extension=$3 [qsa]
    RewriteRule ^feed/userid/([0-9]+)(|/[0-9]+)\.([\w]+) /syndicator.php?page=$2&u=$1&extension=$3 [qsa]
    RewriteRule ^user/([^\/]+)/map/?(.*)$ /mapbrowse.php?user=$1&t=$2
    RewriteRule ^user/([^\/]+)/mmap/?(.*)$ /mapbrowse2.php?mt=tm&user=$1&t=$2
    RewriteRule ^user/([^\/]+)/all/?$ /profile.php?user=$1&all=1
    RewriteRule ^user/([^\/]+)/more/?$ /profile.php?user=$1&more=1
    RewriteRule ^user/([^\/]+)/?$ /profile.php?user=$1

    RewriteRule ^profile/(\d+)/map/?(.*)$ /mapbrowse.php?u=$1&t=$2
    RewriteRule ^profile/(\d+)/mmap/?(.*)$ /mapbrowse2.php?mt=tm&u=$1&t=$2
    RewriteRule ^profile/(\d+)/all/?$ /profile.php?id=$1&all=1
    RewriteRule ^profile/(\d+)/more/?$ /profile.php?id=$1&more=1
    RewriteRule ^profile/(\d+)/?$ /profile.php?id=$1 [qsa]

    RewriteRule ^map/(.*) /mapbrowse.php?t=$1 [qsa]
    RewriteRule ^map2/(.*) /mapbrowse2.php?t=$1 [qsa]
    RewriteRule ^article/([\w-]+)/?$ /article/article.php?page=$1 [qsa]
    RewriteRule ^gallery/([\w-]+)/?([0-9]?)/?$ /gallery/gallery.php?url=$1&page=$2 [qsa]
    RewriteRule ^explore/places/([0-9]?)/?([\w-]*)/? /explore/places.php?ri=$1&adm1=$2 [qsa]

    RewriteRule ^reg/([^/]+)/(.*) /register.php?u=$1&confirm=$2 [qsa]
    RewriteRule ^list/([A-Z]{1,2}) /list.php?square=$1 [qsa]


    RewriteRule ^credits/?([\d-]*)/?$ /credits.php?when=$1
    RewriteRule ^contributors/(\d+) /statistics/breakdown.php?by=user&i=$1

    RewriteRule ^content/feed/recent\.([\w]+) /content/syndicator.php?extension=$1 [qsa]
    RewriteRule ^article/feed/recent\.([\w]+) /article/syndicator.php?extension=$1 [qsa]
    RewriteRule ^events/feed\.([\w]+) /events/syndicator.php?extension=$1 [qsa]

    RewriteRule ^feed/recent\.([\w]+) /syndicator.php?extension=$1 [qsa]
    RewriteRule ^feed/recent/?([^/]*)/? /syndicator.php?format=$1 [qsa]

    RewriteRule ^feed/results/([0-9]+)(|/[0-9]+)\.nl$ /kml.php?page=$2&i=$1&submit=1&simple=1&type=view [qsa]
    RewriteRule ^feed/results/([0-9]+)(|/[0-9]+)\.([\w]+) /syndicator.php?page=$2&i=$1&extension=$3 [qsa]
    RewriteRule ^feed/results([0-9]*)/([0-9]+)/?([^/]*)/? /syndicator.php?page=$1&i=$2&format=$3 [qsa]

    RewriteRule ^results/([0-9]+)(/[0-9]+|)\.?([\w]*)$ /search.php?page=$2&i=$1&extension=$3 [qsa]


    RewriteRule ^discuss/topic([0-9]+) /discuss/?action=vthread&topic=$1 [qsa,r]
    RewriteRule ^discuss/forum([0-9]+) /discuss/?action=vtopic&forum=$1 [qsa,r]
    RewriteRule ^discuss/feed/recent\.([\w]+) /discuss/syndicator.php?extension=$1 [qsa]
    RewriteRule ^discuss/feed/recent/?([^/]*) /discuss/syndicator.php?format=$1 [qsa]
    RewriteRule ^discuss/feed/forum([0-9]+)\.([\w]+) /discuss/syndicator.php?forum=$1&extension=$2 [qsa]
    RewriteRule ^discuss/feed/forum([0-9]+)/?([^/]*) /discuss/syndicator.php?forum=$1&format=$2 [qsa]

    RewriteRule ^get-juppy.jnlp /get-juppy.php [qsa]

    RewriteRule ^sitemap.xml$ /sitemap/root/sitemap.xml [L]
    RewriteRule ^sitemap(\d+).xml.gz$ /sitemap/root/sitemap$1.xml.gz [L]
    RewriteRule ^(sitemap[\d\w\.-]*\.xml.*)$ /sitemap/root/$1 [L]

    #rewrite imagemap clicks as regular urls - must do this otherwise
    #php's use_trans_sid will break the urls
    RewriteCond %{QUERY_STRING} (.+)\?([0-9]+),([0-9]+)$
    RewriteRule ^mapbrowse\.php /mapbrowse.php?x=%2&y=%3&%1

    RewriteCond %{QUERY_STRING} (.+)\?([0-9]+),([0-9]+)$
    RewriteRule ^mapbrowse2\.php /mapbrowse2.php?x=%2&y=%3&%1


    RewriteRule ^(.*)\.v[0-9]+\.(css|js)$ /$1.$2 [L]

    #RewriteRule ^g/(.*) http://%{HTTP_HOST}/gridref/$1 [qsa,L,R=permanent]
    #RewriteRule ^u/(.*) http://%{HTTP_HOST}/profile/$1 [qsa,L,R=permanent]
    #RewriteRule ^p/(.*) http://%{HTTP_HOST}/photo/$1 [qsa,L,R=permanent]
    #RewriteRule ^r/(.*) http://%{HTTP_HOST}/results/$1 [qsa,L,R=permanent]

    ErrorDocument 404 /staticpage.php?page=404

	RewriteCond %{HTTP_REFERER} ^http://(.+\.)?myspace\.com/ [NC,OR]
	RewriteCond %{HTTP_REFERER} ^http://(.+\.)?facebook\.com/ [NC,OR]
	RewriteCond %{HTTP_REFERER} ^http://(.+\.)?blogspot\.com/ [NC,OR]
	RewriteCond %{HTTP_REFERER} ^http://(.+\.)?livejournal\.com/ [NC,OR]
	RewriteCond %{HTTP_REFERER} ^http://altlab\.com/ [NC]
	RewriteRule /photos/.*\.jpg$ /stuff/nohotlink.php [L]


